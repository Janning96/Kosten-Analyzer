<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kosten Analyzer — Barclays & N26 Import (v0.4)</title>
    <style>
      :root { --bg:#0b1020; --card:#131a2e; --muted:#8ea0c6; --accent:#6cf; --good:#0a8; --bad:#e55; }
      html,body { margin:0; padding:0; background:var(--bg); color:#e8efff; font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      header { padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.08); }
      h1 { margin:0; font-size:20px; }
      main { padding:20px; display:grid; gap:16px; }
      .grid { display:grid; gap:16px; grid-template-columns:1fr 1fr; }
      .card { background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,.25); }
      .muted { color:var(--muted); }
      .controls { display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center; margin-bottom:8px; }
      button { background:#1c2545; border:1px solid rgba(255,255,255,.12); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; }
      button:hover { background:#212b56; }
      button.primary { background:var(--accent); color:#001633; border:none; font-weight:600; }
      button.danger { background:#2b1730; color:#ffd8df; border-color:#723; }
      table { width:100%; border-collapse:collapse; }
      th, td { text-align:left; padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,.08); vertical-align:top; }
      th { font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); }
      tbody tr:hover { background:rgba(255,255,255,.03); }
      .num { text-align:right; font-variant-numeric:tabular-nums; }
      .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2746; color:#b7c7f0; font-size:12px; }
      .iconbtn { width:28px; height:28px; border-radius:8px; display:inline-grid; place-items:center; font-weight:700; }
      .iconbtn.minus { background:#2a1a1a; color:#ffb0b0; border:1px solid #5a2a2a; }
      .iconbtn.plus { background:#152a19; color:#a8ffcf; border:1px solid #295a39; }
      .hidden { display:none; }
      .error { color:#ffbaba; background:#3a1a1a; border:1px solid #a33; padding:10px; border-radius:10px; }
      .ok { color:#c4ffd7; background:#153123; border:1px solid #285a39; padding:6px 8px; border-radius:8px; font-size:12px; }
      .bad { color:#ffd2d2; background:#3a1a1a; border:1px solid #6d2a2a; padding:6px 8px; border-radius:8px; font-size:12px; }
      .statuslist { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
      .statusrow { display:flex; gap:10px; align-items:center; }
      .statusrow .name { font-weight:600; }
      footer { color:var(--muted); font-size:12px; padding:16px 20px; border-top:1px solid rgba(255,255,255,.08); }
      .small { font-size:12px; }
      .right { text-align:right; }
    </style>
  </head>
  <body>
    <header>
      <h1>Kosten Analyzer — <span class="muted">Barclays & N26 Import (stabil, v0.4)</span></h1>
    </header>

    <main>
      <section class="grid">
        <div class="card">
          <h3>Barclays (DE)</h3>
          <div class="controls">
            <input id="fileBarclays" type="file" accept="application/pdf" multiple />
            <button id="btnBarclays" class="primary">Barclays importieren</button>
            <span class="small">Zuletzt: <b id="lastBarclays">–</b></span>
          </div>
          <div class="statuslist" id="statusBarclays"></div>
        </div>

        <div class="card">
          <h3>N26 (DE)</h3>
          <div class="controls">
            <input id="fileN26" type="file" accept="application/pdf" multiple />
            <button id="btnN26" class="primary">N26 importieren</button>
            <span class="small">Zuletzt: <b id="lastN26">–</b></span>
          </div>
          <div class="statuslist" id="statusN26"></div>
        </div>
      </section>

      <section class="card">
        <div class="controls">
          <h3 style="margin:0">Importliste <span id="incCount" class="chip">0</span></h3>
          <span style="flex:1"></span>
          <button id="exportCsvBtn" class="primary" disabled>CSV exportieren</button>
          <button id="clearBtn" class="danger">Zurücksetzen</button>
        </div>
        <table id="includeTable">
          <thead>
            <tr><th>Bank</th><th>Quelle</th><th>Belegdatum</th><th>Valutadatum</th><th>Beschreibung</th><th class="num">Betrag (€)</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card">
        <h3 style="margin:0">Ausgeschlossen <span id="excCount" class="chip">0</span></h3>
        <table id="excludeTable">
          <thead>
          <tr><th>Bank</th><th>Quelle</th><th>Belegdatum</th><th>Valutadatum</th><th>Beschreibung</th><th class="num">Betrag (€)</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card">
        <h3>Debug</h3>
        <div id="error" class="error hidden"></div>
        <details><summary>Rohtext (gekürzt)</summary>
          <pre id="debugText" class="small muted" style="white-space:pre-wrap"></pre>
        </details>
      </section>
    </main>

    <footer>
      <div>v0.4 — <span class="muted">pdf.js v3 UMD + workerSrc • getrennte Buttons/Parser für Barclays & N26 • letzte Datei & Status je Bank • N26-Parser deutsch, zeilenbasiert & fehlertolerant.</span></div>
    </footer>

    <!-- pdf.js v3 UMD + explicit worker -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>try{pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';}catch(e){console.warn(e)}</script>

    <script>
      const EURO = new Intl.NumberFormat('de-DE', { style:'decimal', minimumFractionDigits:2, maximumFractionDigits:2 });

      const els = {
        fileBarclays: document.getElementById('fileBarclays'),
        btnBarclays: document.getElementById('btnBarclays'),
        statusBarclays: document.getElementById('statusBarclays'),
        lastBarclays: document.getElementById('lastBarclays'),

        fileN26: document.getElementById('fileN26'),
        btnN26: document.getElementById('btnN26'),
        statusN26: document.getElementById('statusN26'),
        lastN26: document.getElementById('lastN26'),

        incTableBody: document.querySelector('#includeTable tbody'),
        excTableBody: document.querySelector('#excludeTable tbody'),
        incCount: document.getElementById('incCount'),
        excCount: document.getElementById('excCount'),
        exportBtn: document.getElementById('exportCsvBtn'),
        clearBtn: document.getElementById('clearBtn'),
        err: document.getElementById('error'),
        debugText: document.getElementById('debugText'),
      };

      const state = {
        included: [],
        excluded: [],
      };

      function setError(msg){ els.err.textContent = msg; els.err.classList.toggle('hidden', !msg); }

      function normalizeText(s){
        return s.replace(/\u00A0/g, ' ')
                .replace(/\u2212/g, '-')
                .replace(/[ \t]+/g, ' ')
                .replace(/\s+\n/g, '\n')
                .trim();
      }

      function csvEscape(v){
        const s = String(v);
        if (/[",;\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
        return s;
      }
      function toCSV(rows){
        const header = ['Bank','Quelle','Belegdatum','Valutadatum','Beschreibung','Betrag'];
        const lines = [header.join(';')];
        for(const r of rows){
          lines.push([
            r.Bank,
            r.Quelle || '',
            r.Belegdatum || '',
            r.Valutadatum || '',
            r.Beschreibung,
            r.Betrag.toFixed(2).replace('.', ','),
          ].map(csvEscape).join(';'));
        }
        return '\ufeff' + lines.join('\n');
      }
      function cleanDescriptionBarclays(s){
        let out = s.replace(/\s+/g, ' ').trim();
        out = out.replace(/\s+(?:[A-Z]{2}\s+)?Visa$/i, '');
        out = out.replace(/\s+[A-Z]{2}$/i, '');
        out = out.replace(/(\bAIRBNB)\s*\*.*$/i, '$1');
        return out.trim();
      }
      function cleanDescriptionN26(s){
        // N26: Entferne führende Codes/Referenzen wie "Kartenzahlung", "Amazon Mktp ... Bestellnr ..."
        let out = s.replace(/\s+/g,' ').trim();
        out = out.replace(/^Kartenzahlung\s+/i, '');
        // PayPal/N26 vereinheitlichen
        out = out.replace(/PayPal Europe S\.a\.r\.l\. et Cie S\.C\.A.*$/i, 'PayPal Europe S.a.r.l. et Cie S.C.A');
        out = out.replace(/AMZN Mktp.*$/i, 'AMAZON PAYMENTS EUROPE S.C.A.');
        return out.trim();
      }

      function render(){
        const makeRow = (r, toExcluded)=> {
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td>\${r.Bank}</td>
            <td>\${r.Quelle || ''}</td>
            <td>\${r.Belegdatum || ''}</td>
            <td>\${r.Valutadatum || ''}</td>
            <td>\${r.Beschreibung}</td>
            <td class="num">\${EURO.format(r.Betrag)}</td>
            <td class="right"></td>\`;
          const btn = document.createElement('button');
          btn.className = 'iconbtn ' + (toExcluded ? 'minus' : 'plus');
          btn.textContent = toExcluded ? '−' : '+';
          btn.title = toExcluded ? 'Ausschließen' : 'Zurück in Importliste';
          btn.addEventListener('click', () => {
            if (toExcluded){
              state.included = state.included.filter(x => x._id !== r._id);
              state.excluded.unshift(r);
            } else {
              state.excluded = state.excluded.filter(x => x._id !== r._id);
              state.included.unshift(r);
            }
            render();
          });
          tr.lastElementChild.appendChild(btn);
          return tr;
        };
        els.incTableBody.innerHTML = '';
        els.excTableBody.innerHTML = '';
        state.included.forEach(r => els.incTableBody.appendChild(makeRow(r, true)));
        state.excluded.forEach(r => els.excTableBody.appendChild(makeRow(r, false)));
        els.incCount.textContent = state.included.length;
        els.excCount.textContent = state.excluded.length;
        els.exportBtn.disabled = state.included.length === 0;
      }

      async function readPdfToText(file){
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        const pages = [];
        for (let i=1; i<=pdf.numPages; i++){
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(it => it.str).join('\n');
          pages.push(pageText);
        }
        return pages.map(normalizeText);
      }

      // Barclays parser
      function parseBarclays(pages, sourceName){
        const out = [];
        const reLine = /(\d{2}\.\d{2}\.\d{4})\s+(\d{2}\.\d{2}\.\d{4})\s+(.+?)\s+(\d{1,3}(?:\.\d{3})*,\d{2})([+-])/g;
        for (const page of pages){
          const start = page.indexOf('Umsatzübersicht');
          if (start === -1) continue;
          const end = page.indexOf('Umsätze Visa Karten-Nr');
          const seg = page.slice(start, end === -1 ? undefined : end);
          let m;
          while ((m = reLine.exec(seg))){
            const [_, d1, d2, descRaw, amountRaw, sign] = m;
            const desc = descRaw.replace(/\s+/g, ' ').trim();
            if (/Gutschrift Manuelle Lastschrift/i.test(desc)) continue;
            const num = parseFloat(amountRaw.replace(/\./g,'').replace(',','.')) * (sign === '-' ? -1 : 1);
            out.push({
              _id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)),
              Bank: 'Barclays',
              Quelle: sourceName,
              Belegdatum: d1,
              Valutadatum: d2,
              Beschreibung: cleanDescriptionBarclays(desc),
              Betrag: num,
            });
          }
        }
        out.sort((a,b)=> (a.Belegdatum+a.Valutadatum).localeCompare(b.Belegdatum+b.Valutadatum));
        return out;
      }

      // N26 parser (deutsch, zeilenbasiert, tolerant)
      function parseN26(pages, sourceName){
        const out = [];
        const amountRe = /[-+]?\d{1,3}(?:\.\d{3})*,\d{2}(?:-|\+)?/;
        const dateRe = /\b\d{2}\.\d{2}\.\d{4}\b/;
        // Regeln: gesamte Datei scannen; jede Zeile die Datum & Betrag enthält wird als Transaktion betrachtet.
        // Beschreibung = Rest der Zeile ohne Datum(e) und Betrag; 
        // Business-Regel: Ignore, wenn Beschreibung 'Barclays' enthält.
        for (const page of pages){
          const lines = page.split(/\n+/);
          for (let line of lines){
            const l = line.trim();
            if (!dateRe.test(l) || !amountRe.test(l)) continue;
            // Extract amount
            const amountMatch = l.match(amountRe);
            if (!amountMatch) continue;
            let amountRaw = amountMatch[0];
            let sign = 1;
            if (/-$/.test(amountRaw) || amountRaw.startsWith('-')) sign = -1;
            amountRaw = amountRaw.replace(/[-+]/g, '');
            const amount = parseFloat(amountRaw.replace(/\./g,'').replace(',','.')) * sign;
            // Extract first date as booking date; optional second date ignored for N26
            const dateMatch = l.match(dateRe);
            const beleg = dateMatch ? dateMatch[0] : '';
            // Remove dates and amount from description
            let desc = l.replace(amountRe, '').replace(dateRe, '').replace(dateRe, '').replace(/\s{2,}/g,' ').trim();
            desc = cleanDescriptionN26(desc);
            if (/barclays/i.test(desc)) continue; // user rule: N26 ignore descriptions containing 'Barclays'
            if (!desc) continue;
            out.push({
              _id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)),
              Bank: 'N26',
              Quelle: sourceName,
              Belegdatum: beleg,
              Valutadatum: '',
              Beschreibung: desc,
              Betrag: amount,
            });
          }
        }
        // Additional heuristic: detect known header combos and skip them
        return out;
      }

      function pushStatus(el, name, ok, message){
        const row = document.createElement('div');
        row.className = 'statusrow';
        const badge = document.createElement('span'); badge.className = ok ? 'ok' : 'bad'; badge.textContent = ok ? 'OK' : 'Fehler';
        const nm = document.createElement('span'); nm.className = 'name'; nm.textContent = name;
        const msg = document.createElement('span'); msg.className = 'muted small'; msg.textContent = '– ' + message;
        row.append(badge, nm, msg);
        el.prepend(row);
      }

      async function handleImport(files, bank){
        setError('');
        let total = 0; let all = [];
        let targetStatus, lastLabel;
        if (bank==='Barclays'){ targetStatus = els.statusBarclays; lastLabel = els.lastBarclays; }
        if (bank==='N26'){ targetStatus = els.statusN26; lastLabel = els.lastN26; }
        targetStatus.innerHTML='';
        for (const file of files){
          const name = file.name;
          try{
            const pages = await readPdfToText(file);
            els.debugText.textContent = pages.join('\n\n---\n\n').slice(0, 20000);
            let rows = [];
            if (bank==='Barclays') rows = parseBarclays(pages, name);
            if (bank==='N26') rows = parseN26(pages, name);
            if (rows.length===0){
              pushStatus(targetStatus, name, false, '0 Transaktionen erkannt');
            } else {
              pushStatus(targetStatus, name, true, rows.length + ' Transaktionen erkannt');
              total += rows.length;
              all = all.concat(rows);
            }
            lastLabel.textContent = name;
          } catch(e){
            pushStatus(targetStatus, name, false, 'Fehler: ' + (e?.message || String(e)));
          }
        }
        if (total===0){
          setError('Keine Transaktionen erkannt. Prüfe PDF-Typ & Zeitraum. (Debug siehe unten)');
        }
        // merge to included
        state.included = all.concat(state.included);
        render();
      }

      els.btnBarclays.addEventListener('click', ()=> {
        const files = els.fileBarclays.files;
        if (!files || files.length===0){
          pushStatus(els.statusBarclays, '(keine Auswahl)', false, 'Keine Datei gewählt');
          return;
        }
        handleImport(files, 'Barclays');
      });
      els.btnN26.addEventListener('click', ()=> {
        const files = els.fileN26.files;
        if (!files || files.length===0){
          pushStatus(els.statusN26, '(keine Auswahl)', false, 'Keine Datei gewählt');
          return;
        }
        handleImport(files, 'N26');
      });

      els.clearBtn.addEventListener('click', ()=>{
        state.included = []; state.excluded = [];
        els.statusBarclays.innerHTML=''; els.statusN26.innerHTML='';
        els.lastBarclays.textContent='–'; els.lastN26.textContent='–';
        render();
      });

      els.exportBtn.addEventListener('click', ()=> {
        const csv = toCSV(state.included);
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'transaktionen.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      render();
    </script>
  </body>
</html>
