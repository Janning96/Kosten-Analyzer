<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kosten Analyzer — PDF Import (Barclays, v0.1)</title>
    <style>
      :root { --bg:#0b1020; --card:#131a2e; --muted:#8ea0c6; --accent:#6cf; --good:#0a8; --bad:#e55; }
      html,body { margin:0; padding:0; background:var(--bg); color:#e8efff; font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      header { padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.08); }
      h1 { margin:0; font-size:20px; }
      main { padding:20px; display:grid; gap:16px; }
      .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
      .card { background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,.25); }
      .muted { color:var(--muted); }
      .controls { display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center; }
      button, .btn { background:#1c2545; border:1px solid rgba(255,255,255,.12); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; }
      button:hover { background:#212b56; }
      button.primary { background:var(--accent); color:#001633; border:none; font-weight:600; }
      button.danger { background:#2b1730; color:#ffd8df; border-color:#723; }
      table { width:100%; border-collapse:collapse; }
      th, td { text-align:left; padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,.08); vertical-align:top; }
      th { font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); }
      tbody tr:hover { background:rgba(255,255,255,.03); }
      .num { text-align:right; font-variant-numeric:tabular-nums; }
      .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2746; color:#b7c7f0; font-size:12px; }
      .pill { display:inline-flex; align-items:center; gap:6px; background:#17234f; border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:999px; }
      details { margin-top:10px; }
      .small { font-size:12px; }
      .right { text-align:right; }
      .spacer { flex: 1 1 auto; }
      .iconbtn { width:28px; height:28px; border-radius:8px; display:inline-grid; place-items:center; font-weight:700; }
      .iconbtn.minus { background:#2a1a1a; color:#ffb0b0; border:1px solid #5a2a2a; }
      .iconbtn.plus { background:#152a19; color:#a8ffcf; border:1px solid #295a39; }
      footer { color:var(--muted); font-size:12px; padding:16px 20px; border-top:1px solid rgba(255,255,255,.08); }
      .grid2 { display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; }
      .hidden { display:none; }
      .error { color:#ffbaba; background:#3a1a1a; border:1px solid #a33; padding:10px; border-radius:10px; }
      a { color:#9fd6ff; }
    </style>
  </head>
  <body>
    <header>
      <h1>Kosten Analyzer — <span class="muted">PDF Import (Barclays → CSV)</span></h1>
    </header>

    <main>
      <section class="card">
        <div class="controls">
          <label class="pill">
            <input id="pdfInput" type="file" accept="application/pdf" style="display:none" />
            <span id="fileLabel">PDF auswählen…</span>
          </label>
          <button id="chooseBtn">Datei wählen</button>
          <button id="importBtn" class="primary">Import</button>
          <span class="spacer"></span>
          <span class="muted small">Dieses Modul unterstützt zunächst nur <b>Barclays-Kreditkarten</b>–PDFs. N26 kommt als Nächstes.</span>
        </div>
        <div id="error" class="error hidden"></div>
        <details id="debug"><summary>Debug-Infos</summary>
          <pre id="debugText" class="small muted" style="white-space:pre-wrap"></pre>
        </details>
      </section>

      <section class="row">
        <div class="card">
          <div class="grid2">
            <h3 style="margin:0">Importliste <span id="incCount" class="chip">0</span></h3>
            <button id="exportCsvBtn" class="primary" disabled>CSV exportieren</button>
            <button id="clearBtn" class="danger">Zurücksetzen</button>
          </div>
          <table id="includeTable">
            <thead>
              <tr><th>Belegdatum</th><th>Valutadatum</th><th>Beschreibung</th><th class="num">Betrag (€)</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card">
          <h3 style="margin:0">Ausgeschlossen <span id="excCount" class="chip">0</span></h3>
          <table id="excludeTable">
            <thead>
            <tr><th>Belegdatum</th><th>Valutadatum</th><th>Beschreibung</th><th class="num">Betrag (€)</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer>
      <div>v0.1 — <span class="muted">„docs/“ bereit zum Push auf GitHub Pages. Parser: Barclays (DE) stabilisiert auf Zeilen mit Beleg- und Valutadatum, ignoriert <i>Gutschrift Manuelle Lastschrift</i>, normalisiert Dezimaltrennzeichen & Unicode-Minus.</span></div>
    </footer>

    <script type="module">
      import * as pdfjsLib from "https://unpkg.com/pdfjs-dist@4.7.393/build/pdf.min.mjs";
      import "https://unpkg.com/pdfjs-dist@4.7.393/build/pdf.worker.min.mjs";

      const els = {
        input: document.getElementById('pdfInput'),
        chooseBtn: document.getElementById('chooseBtn'),
        importBtn: document.getElementById('importBtn'),
        fileLabel: document.getElementById('fileLabel'),
        incTableBody: document.querySelector('#includeTable tbody'),
        excTableBody: document.querySelector('#excludeTable tbody'),
        exportBtn: document.getElementById('exportCsvBtn'),
        clearBtn: document.getElementById('clearBtn'),
        incCount: document.getElementById('incCount'),
        excCount: document.getElementById('excCount'),
        err: document.getElementById('error'),
        debugText: document.getElementById('debugText'),
      };

      const state = {
        included: [],
        excluded: [],
        sourceFileName: null,
      };

      const EURO = new Intl.NumberFormat('de-DE', { style:'decimal', minimumFractionDigits:2, maximumFractionDigits:2 });

      function setError(msg){ els.err.textContent = msg; els.err.classList.toggle('hidden', !msg); }
      function normalizeText(s){
        return s
          .replace(/\u00A0/g, ' ')
          .replace(/\u2212/g, '-')   // unicode minus
          .replace(/\s+/g, ' ')
          .trim();
      }

      function cleanDescription(s){
        let out = s.replace(/\s+/g, ' ').trim();
        // strip trailing "DE Visa", "LU Visa", "IE Visa" etc
        out = out.replace(/\s+(?:[A-Z]{2}\s+)?Visa$/i, '');
        out = out.replace(/\s+[A-Z]{2}$/i, '');
        // AIRBNB * CODE -> AIRBNB
        out = out.replace(/(\bAIRBNB)\s*\*.*$/i, '$1');
        return out.trim();
      }

      function csvEscape(v){
        const s = String(v);
        if (/[",;\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
        return s;
      }

      function toCSV(rows){
        const header = ['Bank','Quelle','Belegdatum','Valutadatum','Beschreibung','Betrag'];
        const lines = [header.join(';')];
        for(const r of rows){
          lines.push([
            'Barclays',
            state.sourceFileName || '',
            r.Belegdatum,
            r.Valutadatum,
            r.Beschreibung,
            r.Betrag.toFixed(2).replace('.', ','),
          ].map(csvEscape).join(';'));
        }
        return '\ufeff' + lines.join('\n'); // BOM for Excel
      }

      function render(){
        const makeRow = (r, toExcluded)=> {
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td>\${r.Belegdatum}</td>
            <td>\${r.Valutadatum}</td>
            <td>\${r.Beschreibung}</td>
            <td class="num">\${EURO.format(r.Betrag)}</td>
            <td class="right"></td>\`;
          const btn = document.createElement('button');
          btn.className = 'iconbtn ' + (toExcluded ? 'minus' : 'plus');
          btn.textContent = toExcluded ? '−' : '+';
          btn.title = toExcluded ? 'Ausschließen' : 'Zurück in Importliste';
          btn.addEventListener('click', () => {
            if (toExcluded){
              state.included = state.included.filter(x => x._id !== r._id);
              state.excluded.unshift(r);
            } else {
              state.excluded = state.excluded.filter(x => x._id !== r._id);
              state.included.unshift(r);
            }
            render();
          });
          tr.lastElementChild.appendChild(btn);
          return tr;
        };

        els.incTableBody.innerHTML = '';
        els.excTableBody.innerHTML = '';
        state.included.forEach(r => els.incTableBody.appendChild(makeRow(r, true)));
        state.excluded.forEach(r => els.excTableBody.appendChild(makeRow(r, false)));
        els.incCount.textContent = state.included.length;
        els.excCount.textContent = state.excluded.length;
        els.exportBtn.disabled = state.included.length === 0;
      }

      async function readPdfToText(file){
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        const pages = [];
        for (let i=1; i<=pdf.numPages; i++){
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(it => it.str).join('\n');
          pages.push(pageText);
        }
        return pages;
      }

      function parseBarclays(pages){
        // Find the page segment that contains "Umsatzübersicht" and extract until "Umsätze Visa Karten-Nr" (page summary)
        const results = [];
        const reLine = /(\d{2}\.\d{2}\.\d{4})\s+(\d{2}\.\d{2}\.\d{4})\s+(.+?)\s+(\d{1,3}(?:\.\d{3})*,\d{2})([+-])/g;

        for (const page of pages){
          const start = page.indexOf('Umsatzübersicht');
          if (start === -1) continue;
          const end = page.indexOf('Umsätze Visa Karten-Nr');
          const seg = page.slice(start, end === -1 ? undefined : end);
          let m;
          while ((m = reLine.exec(seg))){
            const [_, d1, d2, descRaw, amountRaw, sign] = m;
            const desc = descRaw.replace(/\s+/g, ' ').trim();
            if (/Gutschrift Manuelle Lastschrift/i.test(desc)) continue; // business rule: ignore these
            // amount
            const num = parseFloat(amountRaw.replace(/\./g,'').replace(',','.')) * (sign === '-' ? -1 : 1);
            results.push({
              _id: crypto.randomUUID(),
              Belegdatum: d1,
              Valutadatum: d2,
              BeschreibungOriginal: desc,
              Beschreibung: cleanDescription(desc),
              Betrag: num,
            });
          }
        }

        // Heuristic: sort by Belegdatum then Valutadatum
        results.sort((a,b) => (a.Belegdatum.localeCompare(b.Belegdatum) || a.Valutadatum.localeCompare(b.Valutadatum)));
        return results;
      }

      // UI handlers
      els.chooseBtn.addEventListener('click', () => els.input.click());
      els.input.addEventListener('change', () => {
        els.fileLabel.textContent = els.input.files?.[0]?.name || 'PDF auswählen…';
      });

      els.importBtn.addEventListener('click', async () => {
        setError('');
        const file = els.input.files?.[0];
        if (!file){ setError('Bitte wähle zuerst eine Barclays-PDF aus.'); return; }
        state.sourceFileName = file.name;

        try {
          const pages = (await readPdfToText(file)).map(normalizeText);
          const tx = parseBarclays(pages);
          if (tx.length === 0){
            setError('Keine Transaktionen erkannt. Debug-Ansicht zeigt den erkannten Text.');
          }
          state.included = tx;
          state.excluded = [];
          els.debugText.textContent = pages.join('\n\n---\n\n').slice(0, 25000);
          render();
        } catch (err){
          console.error(err);
          setError('Fehler beim Einlesen: ' + (err?.message || String(err)));
        }
      });

      els.clearBtn.addEventListener('click', () => {
        state.included = []; state.excluded = []; state.sourceFileName = null;
        els.input.value = ''; els.fileLabel.textContent = 'PDF auswählen…';
        render();
      });

      els.exportBtn.addEventListener('click', () => {
        const csv = toCSV(state.included);
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'transaktionen.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      render();
    </script>
  </body>
</html>
